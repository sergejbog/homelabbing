extensions:
   basicauth/server:
      htpasswd:
         inline: |
            ${OTEL_HTPASSWD_ENTRY}

receivers:
   otlp:
      protocols:
         grpc:
            endpoint: "0.0.0.0:4317" # Explicitly bind to all interfaces
            auth:
               authenticator: basicauth/server
         http:
            endpoint: "0.0.0.0:4318" # Explicitly bind to all interfaces
            auth:
               authenticator: basicauth/server
   # Defines a Prometheus configuration set.
   prometheus:
      # Define a set of configurations for scraping by the OpenTelemetry Collector.
      config:
         # The `scrape_configs` section pertains to the Prometheus `scrape_configs`
         # configuration block.
         # See https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config
         scrape_configs:
            # Scrape Mimir metrics.
            - job_name: "mimir"
              static_configs:
                 - targets: ["mimir:9009"]
                   labels:
                      service: "mimir"
                      group: "infrastructure"
              # Drop useless cortex metrics at scrape time
              metric_relabel_configs:
                 - source_labels: [__name__]
                   regex: "cortex_.*"
                   action: drop

            # Scrape Loki metrics.
            - job_name: "loki"
              static_configs:
                 - targets: ["${LOKI_HOST}:3100"]
                   labels:
                      service: "loki"
                      group: "infrastructure"

            # Scrape Tempo metrics.
            - job_name: "tempo"
              static_configs:
                 - targets: ["tempo:3200"]
                   labels:
                      service: "tempo"
                      group: "infrastructure"

            # Scrape Grafana metrics.
            - job_name: "grafana"
              static_configs:
                 - targets: ["grafana:3000"]
                   labels:
                      service: "grafana"
                      group: "infrastructure"

            # Remote Node Exporters for system metrics (CPU, RAM, Disk)
            # Add your remote servers here - replace with actual IPs/hostnames
            - job_name: "node-exporter-hetzner"
              static_configs:
                 # Local server (if running node-exporter locally)
                 - targets: ["${MAIN_SERVER_IP}:9100"]
                   labels:
                      service: "node-exporter-hetzner"
                      group: "hetzner"
                      location: "hetzner-cloud"
                      instance: "main-server"
                 - targets: ["${SECONDARY_SERVER_IP}:9100"]
                   labels:
                      service: "node-exporter-ex44"
                      group: "hetzner"
                      location: "hetzner-barebones-metal"
                      instance: "ex44-server"
              scrape_interval: 15s
              metrics_path: /metrics

            # Remote cAdvisor for Docker container metrics
            - job_name: "cadvisor"
              static_configs:
                 # Local cAdvisor
                 - targets: ["localhost:8080"]
                   labels:
                      service: "cadvisor"
                      group: "containers"
                      location: "local"
                      instance: "main-server"
                 # Add your remote cAdvisor instances here - examples:
                 # - targets: ["192.168.1.100:8080"]
                 #   labels:
                 #      service: "cadvisor"
                 #      group: "containers"
                 #      location: "location1"
                 #      instance: "server1"
              scrape_interval: 15s
              metrics_path: /metrics

processors:
   batch:
   # https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor/batchprocessor

   # Filter processor to drop useless cortex metrics
   filter:
      metrics:
         exclude:
            match_type: regexp
            metric_names:
               - "cortex_.*"

   # Transform processor to fix span status based on your custom attributes
   transform:
      trace_statements:
         - context: span
           statements:
              # Set span status based on your custom "status" attribute
              - set(status.code, 2) where attributes["status"] == "failed"
              - set(status.code, 1) where attributes["status"] == "success"
              # Set status based on error attributes
              - set(status.code, 2) where attributes["error"] == true
              - set(status.code, 2) where attributes["error.message"] != nil
              - set(status.code, 2) where attributes["exception.type"] != nil
              # HTTP status code mapping
              - set(status.code, 2) where attributes["http.status_code"] >= 400
              - set(status.code, 1) where attributes["http.status_code"] >= 200 and attributes["http.status_code"] < 400
              # Default to OK if no explicit error
              - set(status.code, 1) where status.code == 0 and attributes["error"] != true

   # Resource processor to ensure service attributes are properly set
   resource:
      attributes:
         - key: service.name
           action: upsert
           from_attribute: service.name
         - key: service.namespace
           action: upsert
           from_attribute: service.namespace

exporters:
   otlphttp/loki:
      endpoint: http://${LOKI_HOST}:3100/otlp
      tls:
         insecure: true
   otlp/grafana:
      endpoint: "tempo:4317"
      tls:
         insecure: true
   otlphttp:
      endpoint: http://mimir:9009/otlp
      tls:
         insecure: true

service:
   telemetry:
      logs:
         level: debug
   extensions: [basicauth/server]
   pipelines:
      traces:
         receivers: [otlp]
         processors: [resource, transform, batch]
         exporters: [otlp/grafana]
      metrics:
         receivers: [otlp, prometheus]
         processors: [resource, filter, batch]
         exporters: [otlphttp]
      logs:
         receivers: [otlp]
         processors: [resource, batch]
         exporters: [otlphttp/loki]
